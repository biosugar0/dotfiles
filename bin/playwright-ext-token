#!/usr/bin/env python3
"""Extract Playwright MCP Bridge extension token from Chrome's LevelDB storage."""

import glob
import os
import re
import sys

EXTENSION_ID = b"mmlmfjhmonkocbjadbfplnigmagldckm"
LEVELDB_DIR = os.path.expanduser(
    "~/Library/Application Support/Google/Chrome/Default/Local Storage/leveldb/"
)


def extract_token() -> str | None:
    if not os.path.isdir(LEVELDB_DIR):
        return None

    files = sorted(glob.glob(os.path.join(LEVELDB_DIR, "*.ldb"))) + sorted(
        glob.glob(os.path.join(LEVELDB_DIR, "*.log"))
    )

    token = None
    for f in files:
        try:
            with open(f, "rb") as fh:
                data = fh.read()
        except (OSError, PermissionError):
            continue

        idx = 0
        while True:
            idx = data.find(EXTENSION_ID, idx)
            if idx == -1:
                break
            start = max(0, idx - 100)
            nearby = data[start : idx + 200]
            if b"auth-t" in nearby:
                chunk = data[idx : idx + 200]
                printable = "".join(
                    chr(b) if 32 <= b < 127 else " " for b in chunk
                )
                candidates = re.findall(r"[A-Za-z0-9_-]{20,}", printable)
                for c in candidates:
                    if c != EXTENSION_ID.decode():
                        token = c
            idx += 1

    return token


def main() -> None:
    token = extract_token()
    if token:
        print(token)
    else:
        print("ERROR: token not found", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
